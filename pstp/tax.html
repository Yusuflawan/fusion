<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- begin::GXON Meta Basic 245ms-->
    <meta charset="utf-8" />
 
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- Material Symbols Rounded (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
      rel="stylesheet"
    />

    <!-- Material Symbols Sharp (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp"
      rel="stylesheet"
    />

    <title>Fusion</title>
 <link rel="icon" type="image/png" href="assets/images/logo.jpeg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <!-- end::GXON Google Fonts -->

    <!-- begin::GXON Required Stylesheet -->
    <link rel="stylesheet" href="assets/libs/flaticon/css/all/all.css" />
    <link rel="stylesheet" href="assets/libs/lucide/lucide.css" />
    <link rel="stylesheet" href="assets/libs/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/libs/simplebar/simplebar.css" />
    <link rel="stylesheet" href="assets/libs/node-waves/waves.css" />
    <link
      rel="stylesheet"
      href="assets/libs/bootstrap-select/css/bootstrap-select.min.css"
    />
    <link rel="stylesheet" href="assets/css/chart.css" />
    <!-- end::GXON Required Stylesheet -->

    <!-- begin::GXON CSS Stylesheet -->
    <link rel="stylesheet" href="assets/libs/datatables/datatables.min.css" />
    <link rel="stylesheet" href="assets/libs/flatpickr/flatpickr.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/styles.css" />
    <!-- end::GXON CSS Stylesheet -->

    <!-- begin::GXON Googletagmanager -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-XWVQM68HHQ"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XWVQM68HHQ", {
        cookie_flags: "SameSite=None;Secure",
        send_page_view: true,
      });
    </script>
    <!-- end::GXON Googletagmanager -->
  </head>

  <body>
    <div class="page-layout">
      <!-- begin::GXON Page Header -->
      <header class="app-header">
        <div class="app-header-inner" id="header"></div>
      </header>
      <!-- end::GXON Page Header -->

      <!-- begin::GXON Sidebar Menu -->
      
      <!-- begin::GXON Sidebar Menu -->
      <div id="sidebsr" class="app-menubar"></div>
      <!-- end::GXON Sidebar Menu -->
        <main class="app-wrapper">
  <div class="container">
    <!-- Page Header -->
    <div class="app-page-head d-flex flex-wrap gap-3 align-items-center justify-content-between">
      <div class="clearfix">
        <h1 class="app-page-title">Tax Assessments</h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a href="dashboard.html">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Tax Assessments
            </li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- DASHBOARD CARDS -->
    <div class="row mt-3">
      <div class="col-lg-12">
        <div class="row">
          <!-- Total Assessments -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-secondary p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-secondary">
                  <i class="fi fi-sr-wallet fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Assessments</div>
                  <h3 id="total-assessments" class="mb-0 fw-bold text-success mt-3">0</h3>
                  <small>Assessment periods</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Revenue -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-secondary p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-secondary">
                  <i class="fi fi-sr-exchange fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Revenue</div>
                  <h3 id="total-revenue" class="mb-0 fw-bold mt-3">₦0</h3>
                  <small>Assessed revenue</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Tax -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-warning p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-warning">
                  <i class="fi fi-sr-receipt fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Tax</div>
                  <h3 id="total-tax" class="mb-0 fw-bold mt-3">₦0</h3>
                  <small>Tax Liability</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Compliance -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-info p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-info">
                  <i class="bi bi-calculator text-success fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Compliance</div>
                  <h3 id="payment-rate" class="mb-0 fw-bold mt-3">0%</h3>
                  <small>Compliance rate</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12 mt-4">
      <div class="d-flex justify-content-between align-items-center my-3">
        <input type="text" id="searchInput" class="form-control w-25" placeholder="Search merchant, tax name, status...">
        <button class="btn btn-sm btn-outline-secondary" onclick="loadAssessments()">Refresh</button>
      </div>

      <div class="table-responsive shadow-sm rounded-3">
        <table class="table table-striped table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Merchant</th>
              <th>Assessment Period</th>
              <th>Tax Name</th>
              <th>Revenue</th>
              <th>Tax Rate</th>
              <th>Tax Liability</th>
              <th>Due Date</th>
              <th>Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="assessments-table"></tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="assessmentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Assessment Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="assessmentDetails"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const providerId = JSON.parse(localStorage.getItem("user"));
  // console.log();
  let allAssessments = [];

  function formatCurrency(num) {
    return "₦" + Number(num).toLocaleString("en-NG", { maximumFractionDigits: 2 });
  }

  async function loadAssessments() {
    try {
      const res = await fetch(`https://arafatfootballacademy.com/fusion/backend/provider/${providerId?.provider_id}/tax-assessments`);
      const data = await res.json();

      if (data.status !== "success") return;

      const tableBody = document.getElementById("assessments-table");
      tableBody.innerHTML = "";
      allAssessments = [];

      let totalTax = 0;
      let totalCount = 0;
      let totalRevenue = 0;
      let paidCount = 0;

      for (const period in data.data) {
        data.data[period].forEach(merchant => {
          merchant.tax_assessments.forEach(ass => {
            totalTax += parseFloat(ass.tax_liability);
            totalRevenue += parseFloat(ass.taxable_amount);
            totalCount++;
            if (ass.status === "paid") paidCount++;

            const row = `
              <tr>
                <td>${merchant.marchant_name}<br><small class="text-muted">${merchant.marchant_number}</small></td>
                <td>${ass.period_start} - ${ass.period_end}<br><small class="text-muted">Assessed: ${ass.assessed_at}</small></td>
                <td>${ass.tax_name} <br><small class="text-muted">${ass.code}</small></td>
                <td>${formatCurrency(ass.taxable_amount)}</td>
                <td>${ass.tax_rate}%</td>
                <td class="fw-bold text-success">${formatCurrency(ass.tax_liability)}</td>
                <td>${ass.due_date}</td>
                <td><span class="badge ${ass.status === "paid" ? "bg-success" : "bg-warning"} rounded-pill">${ass.status}</span></td>
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-primary" onclick='viewAssessment(${JSON.stringify({...ass, marchant_name: merchant.marchant_name, marchant_number: merchant.marchant_number})})'>
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </td>
              </tr>
            `;
            tableBody.insertAdjacentHTML("beforeend", row);

            allAssessments.push({...ass, marchant_name: merchant.marchant_name, marchant_number: merchant.marchant_number});
          });
        });
      }

      document.getElementById("total-assessments").textContent = totalCount;
      document.getElementById("total-tax").textContent = formatCurrency(totalTax);
      document.getElementById("total-revenue").textContent = formatCurrency(totalRevenue);
      document.getElementById("payment-rate").textContent = totalCount > 0 ? ((paidCount / totalCount) * 100).toFixed(0) + "%" : "0%";

    } catch (err) {
      console.error("Error loading assessments:", err);
    }
  }

  function viewAssessment(ass) {
    const details = `
      <p><strong>Merchant:</strong> ${ass.marchant_name} (${ass.marchant_number})</p>
      <p><strong>Tax Name:</strong> ${ass.tax_name} (${ass.code})</p>
      <p><strong>Period:</strong> ${ass.period_start} - ${ass.period_end}</p>
      <p><strong>Assessed At:</strong> ${ass.assessed_at}</p>
      <p><strong>Taxable Amount:</strong> ${formatCurrency(ass.taxable_amount)}</p>
      <p><strong>Tax Rate:</strong> ${ass.tax_rate}%</p>
      <p><strong>Tax Liability:</strong> ${formatCurrency(ass.tax_liability)}</p>
      <p><strong>Due Date:</strong> ${ass.due_date}</p>
      <p><strong>Status:</strong> <span class="badge ${ass.status === "paid" ? "bg-success" : "bg-warning"}">${ass.status}</span></p>
      <p><strong>Paid By:</strong> ${ass.paid_by ?? "Not Paid"}</p>
    `;
    document.getElementById("assessmentDetails").innerHTML = details;
    new bootstrap.Modal(document.getElementById("assessmentModal")).show();
  }

  // Search filter
  document.getElementById("searchInput").addEventListener("input", function () {
    const q = this.value.toLowerCase();
    const tableBody = document.getElementById("assessments-table");
    tableBody.innerHTML = "";
    allAssessments.filter(a =>
      a.marchant_name.toLowerCase().includes(q) ||
      a.tax_name.toLowerCase().includes(q) ||
      a.status.toLowerCase().includes(q)
    ).forEach(ass => {
      const row = `
        <tr>
          <td>${ass.marchant_name}<br><small class="text-muted">${ass.marchant_number}</small></td>
          <td>${ass.period_start} - ${ass.period_end}<br><small class="text-muted">Assessed: ${ass.assessed_at}</small></td>
          <td>${ass.tax_name} <br><small class="text-muted">${ass.code}</small></td>
          <td>${formatCurrency(ass.taxable_amount)}</td>
          <td>${ass.tax_rate}%</td>
          <td class="fw-bold text-success">${formatCurrency(ass.tax_liability)}</td>
          <td>${ass.due_date}</td>
          <td><span class="badge ${ass.status === "paid" ? "bg-success" : "bg-warning"} rounded-pill">${ass.status}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary" onclick='viewAssessment(${JSON.stringify(ass)})'>
              <i class="fa-solid fa-eye"></i>
            </button>
          </td>
        </tr>
      `;
      tableBody.insertAdjacentHTML("beforeend", row);
    });
  });

  document.addEventListener("DOMContentLoaded", loadAssessments);
</script>





    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="assets/js/header.js"></script>
    <script src="assets/js/chartrtt.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/libs/chartjs/chart.js"></script>
    <script src="assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="assets/libs/datatables/datatables.min.js"></script>
    <script src="assets/libs/global/global.min.js"></script>
    <script src="assets/libs/flatpickr/flatpickr.min.js"></script>
    <script src="assets/js/flatpickr.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/appSettings.js"></script>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- begin::GXON Meta Basic 245ms-->
    <meta charset="utf-8" />
 
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- Material Symbols Rounded (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
      rel="stylesheet"
    />

    <!-- Material Symbols Sharp (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp"
      rel="stylesheet"
    />

    <title>Fusion</title>
 <link rel="icon" type="image/png" href="assets/images/logo.jpeg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <!-- end::GXON Google Fonts -->

    <!-- begin::GXON Required Stylesheet -->
    <link rel="stylesheet" href="assets/libs/flaticon/css/all/all.css" />
    <link rel="stylesheet" href="assets/libs/lucide/lucide.css" />
    <link rel="stylesheet" href="assets/libs/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/libs/simplebar/simplebar.css" />
    <link rel="stylesheet" href="assets/libs/node-waves/waves.css" />
    <link
      rel="stylesheet"
      href="assets/libs/bootstrap-select/css/bootstrap-select.min.css"
    />
    <link rel="stylesheet" href="assets/css/chart.css" />
    <!-- end::GXON Required Stylesheet -->

    <!-- begin::GXON CSS Stylesheet -->
    <link rel="stylesheet" href="assets/libs/datatables/datatables.min.css" />
    <link rel="stylesheet" href="assets/libs/flatpickr/flatpickr.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/styles.css" />
    <!-- end::GXON CSS Stylesheet -->

    <!-- begin::GXON Googletagmanager -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-XWVQM68HHQ"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XWVQM68HHQ", {
        cookie_flags: "SameSite=None;Secure",
        send_page_view: true,
      });
    </script>
    <!-- end::GXON Googletagmanager -->
  </head>

  <body>
    <div class="page-layout">
      <!-- begin::GXON Page Header -->
      <header class="app-header">
        <div class="app-header-inner" id="header"></div>
      </header>
      <!-- end::GXON Page Header -->

      <!-- begin::GXON Sidebar Menu -->
      
      <!-- begin::GXON Sidebar Menu -->
      <div id="sidebsr" class="app-menubar"></div>
      <!-- end::GXON Sidebar Menu -->
        <main class="app-wrapper">
  <div class="container">
    <!-- Page Header -->
    <div class="app-page-head d-flex flex-wrap gap-3 align-items-center justify-content-between">
      <div class="clearfix">
        <h1 class="app-page-title">Tax Assessments</h1>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a href="dashboard.html">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Tax Assessments
            </li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- DASHBOARD CARDS -->
    <div class="row mt-3">
      <div class="col-lg-12">
        <div class="row">
          <!-- Total Assessments -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-secondary p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-secondary">
                  <i class="fi fi-sr-wallet fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Assessments</div>
                  <h3 id="total-assessments" class="mb-0 fw-bold text-success mt-3">0</h3>
                  <small>Assessment periods</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Revenue -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-secondary p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-secondary">
                  <i class="fi fi-sr-exchange fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Revenue</div>
                  <h3 id="total-revenue" class="mb-0 fw-bold mt-3">₦0</h3>
                  <small>Assessed revenue</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Tax -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-warning p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-warning">
                  <i class="fi fi-sr-receipt fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Total Tax</div>
                  <h3 id="total-tax" class="mb-0 fw-bold mt-3">₦0</h3>
                  <small>Tax Liability</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Compliance -->
          <div class="col-xxl-3 col-lg-4 col-sm-6">
            <div class="card card-action action-border-info p-1 position-relative">
              <div class="card-body d-flex gap-3 align-items-center p-4">
                <div class="clearfix pe-2 text-info">
                  <i class="bi bi-calculator text-success fs-1"></i>
                </div>
                <div class="clearfix">
                  <div class="mb-1 text-dark fw-bold">Compliance</div>
                  <h3 id="payment-rate" class="mb-0 fw-bold mt-3">0%</h3>
                  <small>Compliance rate</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12 mt-4">
      <div class="d-flex justify-content-between align-items-center my-3">
        <input type="text" id="searchInput" class="form-control w-25" placeholder="Search merchant, tax name, status...">
        <button class="btn btn-sm btn-outline-secondary" onclick="loadAssessments()">Refresh</button>
      </div>

      <div class="table-responsive shadow-sm rounded-3">
  <table class="table table-striped table-bordered table-hover align-middle mb-0">
    <thead class="table-light">
      <tr>
        <th>Month</th>
        <th>Total Revenue</th>
        <th>Total Tax Liability</th>
        <th>Assessments Count</th>
        <th>Status</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody id="assessments-table"></tbody>
  </table>
</div>

<script>
  const providerId = JSON.parse(localStorage.getItem("user"));

  function formatCurrency(num) {
    return "₦" + Number(num).toLocaleString("en-NG", { maximumFractionDigits: 2 });
  }

  async function loadAssessments() {
    try {
      const res = await fetch(
        `https://arafatfootballacademy.com/fusion/backend/provider/${providerId?.provider_id}/tax-assessments`
      );
      const data = await res.json();
      if (data.status !== "success") return;

      const tableBody = document.getElementById("assessments-table");
      tableBody.innerHTML = "";

      for (const period in data.data) {
        const merchants = data.data[period];
        if (!merchants || merchants.length === 0) continue;

        let totalRevenue = 0;
        let totalLiability = 0;
        let totalAssessments = 0;
        let allStatuses = [];
        let anyInvoice = "";

        merchants.forEach(merchant => {
          merchant.tax_assessments.forEach(tax => {
            totalRevenue += parseFloat(tax.taxable_amount);
            totalLiability += parseFloat(tax.tax_liability);
            totalAssessments++;
            allStatuses.push(tax.status);
            if (!anyInvoice) anyInvoice = tax.invoice;
          });
        });

        const isPaid = allStatuses.every(s => s === "paid");
        const statusBadge = isPaid ? "bg-success" : "bg-warning";

        const formattedPeriod =
          period.charAt(0).toUpperCase() + period.slice(1);

        const viewPageUrl = `view_tax_assessments.html?id=1`;
        const payUrl = `https://payjigawa.com/invoiceGeneration/invoice.html?invoice_number=${encodeURIComponent(anyInvoice)}`;
        
        const row = `
          <tr>
            <td>${formattedPeriod}</td>
            <td>${formatCurrency(totalRevenue)}</td>
            <td class="fw-bold text-success">${formatCurrency(totalLiability)}</td>
            <td>${totalAssessments}</td>
            <td><span class="badge ${statusBadge} rounded-pill">${isPaid ? "paid" : "pending"}</span></td>
            <td class="text-center">
              <a href="${viewPageUrl}" class="btn btn-sm btn-outline-primary me-2">
                <i class="fa-solid fa-eye"></i> View
              </a>
              <a href="${payUrl}" target="_blank" class="btn btn-sm btn-outline-success">
                <i class="fa-solid fa-credit-card"></i> Pay
              </a>
            </td>
          </tr>
        `;

        tableBody.insertAdjacentHTML("beforeend", row);
      }

      if (!Object.keys(data.data).length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No assessments available</td></tr>`;
      }

    } catch (err) {
      console.error("Error assessments:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadAssessments);
</script>






    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="assets/js/header.js"></script>
    <script src="assets/js/chartrtt.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/libs/chartjs/chart.js"></script>
    <script src="assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="assets/libs/datatables/datatables.min.js"></script>
    <script src="assets/libs/global/global.min.js"></script>
    <script src="assets/libs/flatpickr/flatpickr.min.js"></script>
    <script src="assets/js/flatpickr.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/appSettings.js"></script>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- begin::GXON Meta Basic 245ms-->
    <meta charset="utf-8" />
 
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />

    <!-- Material Symbols Rounded (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
      rel="stylesheet"
    />

    <!-- Material Symbols Sharp (optional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp"
      rel="stylesheet"
    />

    <title>Fusion</title>
 <link rel="icon" type="image/png" href="assets/images/logo.jpeg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <!-- end::GXON Google Fonts -->

    <!-- begin::GXON Required Stylesheet -->
    <link rel="stylesheet" href="assets/libs/flaticon/css/all/all.css" />
    <link rel="stylesheet" href="assets/libs/lucide/lucide.css" />
    <link rel="stylesheet" href="assets/libs/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/libs/simplebar/simplebar.css" />
    <link rel="stylesheet" href="assets/libs/node-waves/waves.css" />
    <link
      rel="stylesheet"
      href="assets/libs/bootstrap-select/css/bootstrap-select.min.css"
    />
    <link rel="stylesheet" href="assets/css/chart.css" />
    <!-- end::GXON Required Stylesheet -->

    <!-- begin::GXON CSS Stylesheet -->
    <link rel="stylesheet" href="assets/libs/datatables/datatables.min.css" />
    <link rel="stylesheet" href="assets/libs/flatpickr/flatpickr.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="assets/css/styles.css" />
    <!-- end::GXON CSS Stylesheet -->

    <!-- begin::GXON Googletagmanager -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-XWVQM68HHQ"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XWVQM68HHQ", {
        cookie_flags: "SameSite=None;Secure",
        send_page_view: true,
      });
    </script>
    <!-- end::GXON Googletagmanager -->
  </head>

  <body>
    <div class="page-layout">
      <!-- begin::GXON Page Header -->
      <header class="app-header">
        <div class="app-header-inner" id="header"></div>
      </header>
      <!-- end::GXON Page Header -->

      <!-- begin::GXON Sidebar Menu -->
      
      <!-- begin::GXON Sidebar Menu -->
      <div id="sidebsr" class="app-menubar"></div>
      <!-- end::GXON Sidebar Menu -->
         <main class="app-wrapper">
        <div class="container">
          <div
            class="app-page-head d-flex flex-wrap gap-3 align-items-center justify-content-between"
          >
            <div class="clearfix">
              <h1 class="app-page-title">Tax Assessments</h1>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item">
                    <a href="dashboard.html">Dashboard</a>
                  </li>
                  <li class="breadcrumb-item active" aria-current="page">
                    Tax Assessments
                  </li>
                </ol>
              </nav>
            </div>
          </div>

          <!-- Your Template -->
          <div class="row">
            <div class="container-fluid">
              <div class="row">
                <div class="col-lg-12">
                  <div class="row">
                    <!-- Total Assessments -->
                    <!-- <div class="col-xxl-3 col-lg-4 col-sm-6">
                      <div
                        class="card card-action action-border-secondary p-1 position-relative"
                      >
                        <div
                          class="card-body d-flex gap-3 align-items-center p-4"
                        >
                          <div class="clearfix pe-2 text-secondary">
                            <i class="fi fi-sr-wallet fs-1"></i>
                          </div>
                          <div class="clearfix">
                            <div class="mb-1 text-dark fw-bold">
                              Total Assessments
                            </div>
                            <h3
                              id="total-assessments"
                              class="mb-0 fw-bold text-success mt-3"
                            >
                              0
                            </h3>
                            <small>Assessment periods</small>
                          </div>
                        </div>
                      </div>
                    </div> -->

                    <!-- Total Revenue -->
                    <!-- <div class="col-xxl-3 col-lg-4 col-sm-6">
                      <div
                        class="card card-action action-border-secondary p-1 position-relative"
                      >
                        <div
                          class="card-body d-flex gap-3 align-items-center p-4"
                        >
                          <div class="clearfix pe-2 text-secondary">
                            <i class="fi fi-sr-exchange fs-1"></i>
                          </div>
                          <div class="clearfix">
                            <div class="mb-1 text-dark fw-bold">
                              Total Revenue
                            </div>
                            <h3 id="total-revenue" class="mb-0 fw-bold mt-3">
                              ₦0
                            </h3>
                            <small>Assessed revenue</small>
                          </div>
                        </div>
                      </div>
                    </div> -->

                    <!-- Total Tax -->
                    <!-- <div class="col-xxl-3 col-lg-4 col-sm-6">
                      <div
                        class="card card-action action-border-warning p-1 position-relative"
                      >
                        <div
                          class="card-body d-flex gap-3 align-items-center p-4"
                        >
                          <div class="clearfix pe-2 text-warning">
                            <i class="fi fi-sr-receipt fs-1"></i>
                          </div>
                          <div class="clearfix">
                            <div class="mb-1 text-dark fw-bold">Total Tax</div>
                            <h3 id="total-tax" class="mb-0 fw-bold mt-3">₦0</h3>
                            <small>Tax Liability</small>
                          </div>
                        </div>
                      </div>
                    </div> -->

                    <!-- Payment Compliance -->
                    <!-- <div class="col-xxl-3 col-lg-4 col-sm-6">
                      <div
                        class="card card-action action-border-info p-1 position-relative"
                      >
                        <div
                          class="card-body d-flex gap-3 align-items-center p-4"
                        >
                          <div class="clearfix pe-2 text-info">
                            <i class="bi bi-calculator text-success fs-1"></i>
                          </div>
                          <div class="clearfix">
                            <div class="mb-1 text-dark fw-bold">
                              Compliance
                            </div>
                            <h3 id="payment-rate" class="mb-0 fw-bold mt-3">
                              0%
                            </h3>
                            <small>Compliance rate</small>
                          </div>
                        </div>
                      </div>
                    </div> -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <script>
            function formatCurrency(num) {
              return (
                "₦" +
                Number(num).toLocaleString("en-NG", {
                  maximumFractionDigits: 2,
                })
              );
            }

            async function loadDashboard() {
              try {
                const token = localStorage.getItem("token");
                if (!token) {
                  console.error("Token not found in localStorage");
                  return;
                }

                const profileRes = await fetch(
                  "https://arafatfootballacademy.com/fusion/backend/profile",
                  {
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  }
                );

                const profileData = await profileRes.json();

                if (profileData.status !== "success") {
                  console.error("Failed to load profile:", profileData.message);
                  return;
                }

                const merchant_number = profileData.data?.marchant_number;
                if (!merchant_number) {
                  console.error(
                    "merchant_number not found in profile response"
                  );
                  return;
                }

                const aggRes = await fetch(
                  `https://arafatfootballacademy.com/fusion/backend/marchant/${merchant_number}/tax-assessments/aggregate`
                );

                const aggData = await aggRes.json();

                if (aggData.status === "success") {
                  const stats = aggData.data;

                  document.getElementById("total-assessments").textContent =
                    stats.total_assessments;
                  document.getElementById("total-revenue").textContent =
                    formatCurrency(stats.total_revenue);
                  document.getElementById("total-tax").textContent =
                    formatCurrency(stats.total_tax_liability);

                  let rate = parseFloat(stats.payment_compliance_rate);
                  if (!isNaN(rate)) {
                    rate = (rate * 100).toFixed(0) + "%";
                  } else {
                    rate = "0%";
                  }
                  document.getElementById("payment-rate").textContent = rate;
                }
              } catch (error) {
                console.error("Error loading dashboard:", error);
              }
            }

            document.addEventListener("DOMContentLoaded", loadDashboard);
          </script>




<div class="container mt-4">
  <div class="mb-3">
    <label for="providerSelect" class="form-label fw-semibold">Select Provider</label>
    <select id="providerSelect" class="form-select">
      <option value="">-- Select a Provider --</option>
    </select>
  </div>
  <div class="col-lg-12">
    <div class="table-responsive mt-4 shadow-sm rounded-3">
      <table class="table table-striped table-bordered table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>PTSP / PSSP</th>
            <th>Assessment Period</th>
            <th>Tax Liability</th>
            <th>Due Date</th>
            <th>Invoice Number</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="assessmentTableBody">
          <tr>
            <td colspan="6" class="text-center text-muted">No data loaded yet</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
async function loadProviders() {
  try {
    const res = await fetch("https://arafatfootballacademy.com/fusion/backend/providers");
    const result = await res.json();

    if (result.status === "success") {
      const providers = result.data;
      const providerSelect = document.getElementById("providerSelect");

      providers.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.provider_name;
        providerSelect.appendChild(opt);
      });
    }
  } catch (err) {
    console.error("Error fetching providers:", err);
  }
}

document.getElementById("providerSelect").addEventListener("change", async (e) => {
  const providerId = e.target.value;
  if (!providerId) return;

  try {
    const res = await fetch(`https://arafatfootballacademy.com/fusion/backend/provider/${providerId}/monthly-assessments`);
    const result = await res.json();

    renderTable(result.data);
  } catch (err) {
    console.error("Error fetching tax assessments:", err);
  }
});

function renderTable(data) {
  const tbody = document.getElementById("assessmentTableBody");
  tbody.innerHTML = "";

  if (!data || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No assessments found</td></tr>`;
    return;
  }

  data.forEach(item => {
    const totalLiability = item.assessments.reduce((sum, a) => sum + parseFloat(a.total_tax_liability), 0);


    const breakdown = item.assessments.map(a => 
      `<div class="small text-muted">${a.tax_type_name}: ₦${parseFloat(a.total_tax_liability).toLocaleString()}</div>`
    ).join("");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.provider_name}</td>
      <td>${formatMonth(item.month)}</td>
      <td>
        <strong>₦${totalLiability.toLocaleString()}</strong>
        <br>
        ${breakdown}
      </td>
      <td>${item.due_date}</td>
      <td>${item.invoice}</td>
      <td>
        <span class="badge ${item.status === "paid" ? "bg-success" : "bg-warning"} rounded-pill px-3">
          ${item.status}
        </span>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function formatMonth(monthStr) {
  const [year, month] = monthStr.split("-");
  const date = new Date(`${month}-01-${year}`);
  return date.toLocaleDateString("en-US", { month: "long", year: "numeric" });
}

loadProviders();
</script>



        </div>
      </main>




    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="assets/js/header.js"></script>
    <script src="assets/js/chartrtt.js"></script>
    <script src="assets/js/chart.js"></script>
    <script src="assets/libs/chartjs/chart.js"></script>
    <script src="assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="assets/libs/datatables/datatables.min.js"></script>
    <script src="assets/libs/global/global.min.js"></script>
    <script src="assets/libs/flatpickr/flatpickr.min.js"></script>
    <script src="assets/js/flatpickr.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/appSettings.js"></script>
</div>
</body>
</html>
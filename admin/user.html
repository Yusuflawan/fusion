<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- begin::GXON Meta Basic -->
    <meta charset="utf-8" />
    <title>Payroll | Fusion HR Management Admin Dashboard</title>
    <link rel="icon" type="image/png" href="assets/images/logo.jpeg" />
    <!-- end::GXON Website Page Title -->

    <!-- begin::GXON Mobile Specific -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <!-- end::GXON Google Fonts -->

    <!-- begin::GXON Required Stylesheet -->
    <link rel="stylesheet" href="assets/libs/flaticon/css/all/all.css" />
    <link rel="stylesheet" href="assets/libs/lucide/lucide.css" />
    <link rel="stylesheet" href="assets/libs/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/libs/simplebar/simplebar.css" />
    <link rel="stylesheet" href="assets/libs/node-waves/waves.css" />
    <link
      rel="stylesheet"
      href="assets/libs/bootstrap-select/css/bootstrap-select.min.css"
    />
    <!-- end::GXON Required Stylesheet -->

    <!-- begin::GXON CSS Stylesheet -->
    <link rel="stylesheet" href="assets/libs/datatables/datatables.min.css" />
    <link rel="stylesheet" href="assets/libs/flatpickr/flatpickr.min.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <!-- end::GXON CSS Stylesheet -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/my.css" />

    <!-- begin::GXON Googletagmanager -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-XWVQM68HHQ"
    ></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-XWVQM68HHQ", {
        cookie_flags: "SameSite=None;Secure",
        send_page_view: true,
      });
    </script>
    <!-- end::GXON Googletagmanager -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <main>
      <div class="page-layout">
        <!-- begin::GXON Page Header -->
        <header class="app-header">
          <div class="app-header-inner" id="header"></div>
        </header>

        <div
          class="modal fade"
          id="searchResultsModal"
          tabindex="-1"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header py-1 px-3">
                <form
                  class="d-flex align-items-center position-relative w-100"
                  action="leave.html#"
                >
                  <button
                    type="button"
                    class="btn btn-sm border-0 position-absolute start-0 p-0 text-sm"
                  >
                    <i class="fi fi-rr-search"></i>
                  </button>
                  <input
                    type="text"
                    class="form-control form-control-lg ps-4 border-0 shadow-none"
                    id="searchInput"
                    placeholder="Search anything's"
                  />
                </form>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body pb-2" style="height: 300px" data-simplebar>
                <div id="recentlyResults">
                  <span
                    class="text-uppercase text-2xs fw-semibold text-muted d-block mb-2"
                    >Recently Searched:</span
                  >
                  <ul class="list-inline search-list">
                    <li>
                      <a class="search-item" href="index.html">
                        <i class="fi fi-rr-apps"></i> Dashboard
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="user.html">
                        <i class="fi fi-rr-comment"></i>User Management
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="roles.html">
                        <i class="fi fi-rr-calendar"></i>Roles & Access control
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="PTSP.html">
                        <i class="fi fi-rr-chart-pie-alt"></i> ptsp onboarding
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="data.html">
                        <i class="fi fi-rr-file"></i>data ingestion monitor
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="audit.html">
                        <i class="fi fi-rr-envelope"></i> audit log
                      </a>
                    </li>
                    <li>
                      <a class="search-item" href="transaction.html">
                        <i class="fi fi-rr-envelope"></i>Tax Transaction Config
                      </a>
                    </li>
                  </ul>
                </div>
                <div id="searchContainer"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- begin::GXON Sidebar Menu -->
        <div id="sidebsr"></div>
        <!-- end::GXON Sidebar Menu -->
      </div>

      <!-- begin::GXON Sidebar right -->
      <div class="app-sidebar-end"></div>
      <!-- end::GXON Sidebar right -->

      <div class="app-wrapper">
        <div class="container">
          <div class="app-page-head row align-items-center mb-4">
            <!-- Left Column: Title and Breadcrumb -->
            <div class="col-md-8">
              <h1 class="app-page-title">User Management</h1>
              <div class="mt-2">
                <span class="d-block" style="font-weight: 900"
                  >Permissions</span
                >
                <small class="text-muted d-block"
                  >Comprehensive insights into system performance and data
                  trends</small
                >
              </div>
            </div>
            <div class="d-flex justify-content-end gap-4 align-items-center">
              <div>
                <div class="container py-3">
                  <select class="form-select" id="userFilter">
                    <option selected>All Users</option>
                    <option>Active Users</option>
                    <option>Inactive Users</option>
                    <option>Executives</option>
                    <option>Compliance Officers</option>
                    <option>Analytics Team</option>
                    <option>Administrator</option>
                  </select>
                </div>
              </div>
              <div>
                <!-- Create New User Button -->
                <button
                  type="button"
                  class="btn btn-primary waves-effect waves-light"
                  data-bs-toggle="modal"
                  data-bs-target="#createUserModal"
                >
                  <i class="fi fi-rr-plus me-1"></i> Create New User
                </button>
              </div>
            </div>
            <!-- Right Column: Button -->
            <div class="col-md-4 text-md-start mt-3 mt-md-0">
              <!-- Create User Modal -->
              <div
                class="modal fade"
                id="createUserModal"
                tabindex="-1"
                aria-labelledby="createUserModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                      <div>
                        <h5 class="modal-title" id="createUserModalLabel">
                          Add New User
                        </h5>
                        <div class="small text-muted">
                          Add new user to the roles
                        </div>
                      </div>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>

                    <!-- Modal Body -->
                    <div class="modal-body">
                      <form id="addUserForm">
                        <div class="mb-3">
                          <label for="userName" class="form-label"
                            >User Name</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="userName"
                            placeholder="Enter user name"
                            required
                          />
                        </div>
                        <div class="mb-3">
                          <label for="userEmail" class="form-label text-dark"
                            >Email Address</label
                          >
                          <input
                            type="email"
                            class="form-control"
                            id="userEmail"
                            placeholder="Enter user email"
                            required
                          />
                        </div>
                        <div class="mb-3">
                          <label for="userDepartment" class="form-label"
                            >Department</label
                          >
                          <select
                            class="form-select"
                            id="userDepartment"
                            required
                          >
                            <option value="" selected disabled>
                              Select department
                            </option>
                            <option value="executive">
                              SIRS Executive Office
                            </option>
                            <option value="tax-compliance">
                              Tax Compliance & Enforcement
                            </option>
                            <option value="data-analytics">
                              Data Analytics & Intelligence
                            </option>
                            <option value="it-admin">IT Administration</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="userRole" class="form-label"
                            >Select</label
                          >
                          <select class="form-select" id="userRole" required>
                            <option value="" disabled selected>
                              Select roles
                            </option>
                          </select>
                        </div>

                        <script>
                          const endpoint =
                            "https://arafatfootballacademy.com/fusion/backend/roles";

                          async function loadRoles() {
                            try {
                              const res = await fetch(endpoint);
                              const result = await res.json();

                              if (result.status === "success") {
                                const roles = result.data;
                                const userRoleSelect =
                                  document.querySelector("#userRole");

                                userRoleSelect.length = 1;

                                roles.forEach((role) => {
                                  const option =
                                    document.createElement("option");
                                  option.value = role.id;
                                  option.textContent = role.name;
                                  userRoleSelect.appendChild(option);
                                });
                              }
                            } catch (err) {
                              console.error("Error roles:", err);
                            }
                          }

                          loadRoles();
                        </script>
                      </form>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer">
                      <button
                        type="submit"
                        form="addUserForm"
                        class="btn btn-primary"
                      >
                        Add New User
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-12">
              <div>
                <div class="container py-4">
                  <div class="row g-3 col-lg-12">
                    <!-- Total Users -->
                    <div class="col-lg-3 col-md-6">
                      <div class="statt-card h-100">
                        <div class="stat-title">
                          Total Users
                          <i class="bi bi-people text-primary icon-up"></i>
                        </div>
                        <div class="stat-value text-dark" id="totalUsers"></div>
                        <div class="stat-subtext">Registered users</div>
                      </div>
                    </div>

                    <!-- Active Users -->
                    <div class="col-lg-3 col-md-6">
                      <div class="statt-card h-100">
                        <div class="stat-title">
                          Active Users
                          <i
                            class="bi bi-check-circle text-success icon-up"
                          ></i>
                        </div>
                        <div
                          class="stat-value text-success"
                          id="activeUsers"
                        ></div>
                        <div class="stat-subtext">Currently active</div>
                      </div>
                    </div>

                    <!-- Compliance Officers -->
                    <div class="col-lg-3 col-md-6">
                      <div class="statt-card h-100">
                        <div class="stat-title">
                          Compliance Officers
                          <i class="bi bi-shield-check text-purple icon-up"></i>
                        </div>
                        <div
                          class="stat-value text-dark"
                          id="complianceOfficers"
                        ></div>
                        <div class="stat-subtext">Field officers</div>
                      </div>
                    </div>

                    <!-- Administrators -->
                    <div class="col-lg-3 col-md-6">
                      <div class="statt-card h-100">
                        <div class="stat-title">
                          Administrators
                          <i class="bi bi-gear text-warning icon-up"></i>
                        </div>
                        <div
                          class="stat-value text-dark"
                          id="administrators"
                        ></div>
                        <div class="stat-subtext">System admins</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="container py-4">
                <div class="card card-custom shadow-sm">
                  <div class="card-body">
                    <h4 class="card-title">System Users</h4>
                    <p class="text-muted mb-4">
                      Manage user accounts and permissions
                    </p>

                    <div class="table-responsive">
                      <table class="table align-middle">
                        <thead>
                          <tr>
                            <th>User</th>
                            <th>Roles</th>
                            <th>Department</th>
                            <th>Last Login</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- begin::GXON Footer --
    <footer class="footer-wrapper bg-body">
      <div class="container">
        <div class="row g-2">
          <div class="col-lg-6 col-md-7 text-center text-md-start">
            <p class="mb-0">
              © <span class="currentYear">2025</span> GXON. Proudly powered by
              <a href="javascript:void(0);">LayoutDrop</a>.
            </p>
          </div>
          <div class="col-lg-6 col-md-5">
            <ul
              class="d-flex list-inline mb-0 gap-3 flex-wrap justify-content-center justify-content-md-end"
            >
              <li>
                <a class="text-body" href="index.html">Home</a>
              </li>
              <li>
                <a class="text-body" href="pages/faq.html">Faq's</a>
              </li>
              <li>
                <a class="text-body" href="pages/faq.html">Support</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    <!-- end::GXON Footer -->

    <!-- begin::GXON Page Scripts -->
    <script src="assets/js/header.js"></script>
    <script src="assets/libs/global/global.min.js"></script>
    <script src="assets/libs/chartjs/chart.js"></script>
    <script src="assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="assets/libs/datatables/datatables.min.js"></script>
    <script src="assets/libs/flatpickr/flatpickr.min.js"></script>
    <script src="assets/js/flatpickr.js"></script>
    <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/appSettings.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
      const totalUsers = document.querySelector("#totalUsers");
      const activeUsers = document.querySelector("#activeUsers");
      const complianceOfficers = document.querySelector("#complianceOfficers");
      const administrators = document.querySelector("#administrators");

      const updateStats = (users) => {
        totalUsers.textContent = users.length;
        activeUsers.textContent = users.filter(
          (user) => user.status === "active"
        ).length;
        complianceOfficers.textContent = users.filter(
          (user) => user.role_name === "Compliance Officer"
        ).length;
        administrators.textContent = users.filter(
          (user) => user.role_name === "Administrator"
        ).length;
      };

      document
        .getElementById("addUserForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const userName = document.getElementById("userName").value.trim();
          const userEmail = document.getElementById("userEmail").value.trim();
          const userDepartment =
            document.getElementById("userDepartment").value;
          const userRole = document.getElementById("userRole").value;

          const data = {
            name: userName,
            email: userEmail,
            department: userDepartment,
            role_id: userRole,
          };

          try {
            const response = await axios.post(
              "https://arafatfootballacademy.com/fusion/backend/admin/auth/register",
              data
            );

            alert("User added successfully!");
            console.log(response.data);
            setTimeout(() => {
              window.location.reload();
            }, 3000);

            document.getElementById("addUserForm").reset();
          } catch (error) {
            console.error(error);
            alert("Please try again.");
          }
        });

      const API_URL = "https://arafatfootballacademy.com/fusion/backend/admins";

      async function loadUsers() {
        try {
          const response = await axios.get(API_URL);
          const users = response.data.data;

          updateStats(users);

          const tbody = document.querySelector("table tbody");
          tbody.innerHTML = "";

          users.forEach((user) => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
        <td>
          <strong>${user.name}</strong><br/>
          <small class="text-muted">${user.email}</small>
        </td>
        <td><span class="badge-role">${user.role_name}</span></td>
        <td>${user.department}</td>
        <td>-</td>
        <td>
          <span class="${
            user.status === "active" ? "status-active" : "status-inactive"
          }">
            ${user.status}
          </span>
        </td>
        <td>
          <!-- Edit icon -->
          <a href="#" class="action-link" data-bs-toggle="modal" data-bs-target="#editUserModal-${
            user.id
          }">
            <i class="bi bi-pencil-square"></i>
          </a>

          <!-- Toggle Switch -->
          <div class="form-check form-switch d-inline-block ms-2">
            <input class="form-check-input toggle-status-switch" type="checkbox" role="switch"
              id="switch-${user.id}" data-id="${user.id}" 
              ${user.status === "active" ? "checked" : ""}>
            <label class="form-check-label small" for="switch-${user.id}">
              ${user.status === "active" ? "Active" : "Inactive"}
            </label>
          </div>

          <!-- Modal -->
          <div class="modal fade" id="editUserModal-${user.id}" tabindex="-1"
            aria-labelledby="editUserModalLabel-${user.id}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content rounded-4">
                <div class="modal-header">
                  <h5 class="modal-title" id="editUserModalLabel-${
                    user.id
                  }">Edit ${user.name}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label class="form-label">Name</label>
                      <input type="text" class="form-control" value="${
                        user.name
                      }">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" value="${
                        user.email
                      }">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Role</label>
                      <input type="text" class="form-control" value="${
                        user.role_name
                      }">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Department</label>
                      <input type="text" class="form-control" value="${
                        user.department
                      }">
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        </td>
      `;

            tbody.appendChild(tr);
          });

          document
            .querySelectorAll(".toggle-status-switch")
            .forEach((switchEl) => {
              switchEl.addEventListener("change", async (e) => {
                const userId = e.target.getAttribute("data-id");
                const newStatus = e.target.checked ? "active" : "inactive";

                try {
                  await axios.put(`${API_URL}/${userId}/status`, {
                    status: newStatus,
                  });
                  loadUsers();
                } catch (err) {
                  console.error(err);
                  alert("Failed to update user status.");
                }
              });
            });
        } catch (err) {
          console.error(err);
          alert("Failed to load users.");
        }
      }

      async function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) return;

        try {
          await axios.delete(`${API_URL}/${userId}`);
          alert("User deleted successfully!");
          loadUsers();
        } catch (err) {
          console.error(err);
          alert("Failed to delete user.");
        }
      }
      document.addEventListener("DOMContentLoaded", loadUsers);
    </script>

    <!-- end::GXON Page Scripts -->
  </body>
</html>
